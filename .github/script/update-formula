#!/usr/bin/env bash

set -e

: "${VERSION:?Must specify version}"
: "${FORMULA:?Must specify formula}"

FORMULA_FILE="Formula/$FORMULA.rb"

# Check if formula file exists
if [[ ! -f "$FORMULA_FILE" ]]; then
  echo "Error: Formula file $FORMULA_FILE not found"
  exit 1
fi

sed_inplace() {
  if [[ "$OSTYPE" == "darwin"* ]]; then
    sed -i '' "$@"
  else
    sed -i "$@"
  fi
}

# Update version
sed_inplace "s/version \".*\"/version \"${VERSION#v}\"/" "$FORMULA_FILE"

# Build the download URL by evaluating the url line from the formula with
# the new version interpolated. This handles any URL pattern.
URL=$(ruby -e "version='${VERSION#v}'; puts $(grep -m1 '^\s*url ' "$FORMULA_FILE" | sed 's/.*url //')")

echo "Fetching $URL"
SHASUM=$(curl -sL "$URL" | shasum -a 256 | awk '{ print $1 }')
echo "  sha256: $SHASUM"

sed_inplace "s/sha256 \".*\"/sha256 \"$SHASUM\"/" "$FORMULA_FILE"
